# 第1章 引言
## 1.1 CDN的基本概念和产生背景

**网络层与应用层存在4个地方可能造成网络拥塞**
1. 服务器接入互联网所能提供的带宽：用户请求数据量可能会超过网站出口带宽
2. 用户接入带宽
3. 对等互联关口。一般两个运营商之间只有两三个 互联互通点的带宽可能造成瓶颈
4. 长途骨干传输。由于距离较远造成的延迟较高，以及互联网大部分流量都要经过骨干网造成骨干网拥塞。

**8秒定律**
如果等待网页打开的时间超过8秒，那么会有超过30%的用户会放弃等待

## 1.2 CDN的基本工作过程
将网站内容注入CDN系统，通过CDN部署在各个物理位置的服务器进行全网分发，就可以实现跨运营商、跨地域的用户覆盖。大量用户方位被分散在完了过边缘就近访问资源，不再造成网站出口、互联互通点的资源占挤，也不需要经过主干网。

#### 互联网用户访问服务器流程（B/S架构）
1. 在浏览器中输入要访问的网站域名
2. 浏览器向本地DNS服务器请求对该域名的解析<br>💡**本地DNS服务器**：指用户计算机配置的DNS地址对应的服务器，一般默认由DHCP配置到运营商的服务器地址，也可以自己设置。
3. 本地有缓存则直接响应用户
4. 否则以 *递归方式* 向整个DNS系统请求解析<br>💡不一定是递归方式
   1. 本地域名服务器向根域名服务区请求顶级域名服务器的ip地址(比如com)
   2. 本地域名服务器根据顶级域名服务器的ip地址向其寻找对应主域名服务器的ip地址(比如baidu.com)
   3. 本地域名服务器根据主域名服务器的ip地址进行下一步的解析(www.baidu.com 或 image.baidu.com)
   4. 如果还有更高层级的解析则继续进行类似的过程
5. 浏览器获得域名解析结果(相应服务器的IP地址)
6. 浏览器向服务器请求内容
7. 服务器将请求内容过传送给浏览器

#### 引入CDN后的典型用户访问流程
> 💡CDN对域名解析过程进行了调整，所以解析函数库一般得到的是该域名对应的CNAME记录
1. 获取邻近的缓存服务器IP
   1. **获取CDN专用DNS服务器地址**<br>用户点击网站页面上的内容URL后，经本地DNS服务器解析，DNS最终会将域名的解析权交给CNAME指向的该网站的CDN专用DNS服务器<br>💡CNAME记录，也叫域名的别名记录，比如 xiaomi.com -> mi.com 的映射
   2. **获取CDN全局负载均衡设备地址**<br>该网站的CDN的DNS服务器将CDN的全局负载均衡设备的IP地址返回给用户
   3. **获取CDN区域负载均衡设备地址**<br>用户向CDN的全局负载设备发起内容URL访问请求，CDN全局负载均衡设备根据用户IP地址，以及用户请求的内容URL，告知用户一台其所属区域的区域负载均衡设备
   4. **获取缓存服务器IP地址**<br>区域负载均衡设备根据用户IP地址、所查询内容、各服务器负载情况向全局负载均衡设备返回一个临近的能够提供服务的缓存服务器地址。
   5. 全局负载均衡设备把服务器IP地址返回给用户。
2. 用户向缓存服务器发起请求，缓存服务器响应用户请求。如果此缓存服务器没有用户想要的内容，则需要向它的上一级缓存服务器请求内容，将其缓存并返回给客户端。

使用CDN服务的网站，只需要将其域名解析权交给CDN的GSLB设备，将需要分发的内容注入CDN，就可以实现内容加速了。
> 💡GSLB(Global Server Load Balance) 全局负载均衡